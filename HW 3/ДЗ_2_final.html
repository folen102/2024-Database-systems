<!DOCTYPE html>
<!-- saved from url=(0287)file:///D:/mipt/%D0%9C%D0%B0%D0%B3%D0%B8%D1%81%D1%82%D1%80%D0%B0%D1%82%D1%83%D1%80%D0%B0/2%20%D1%81%D0%B5%D0%BC%D0%B5%D1%81%D1%82%D1%80/%D0%A1%D0%B8%D1%81%D1%82%D0%B5%D0%BC%D1%8B%20%D0%B1%D0%B0%D0%B7%20%D0%B4%D0%B0%D0%BD%D0%BD%D1%8B%D1%85/2024-Database-systems/HW%203/%D0%94%D0%97_2.html -->
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>PouchDB</title>
  
  <meta name="viewport" content="width=device-width, initial-scale=1">
</head>

<body>
  <!-- DOM -->
  <div class="App">
    <button id="add">Add</button>
    <button id="remove">Remove</button>
    <button id="sync">Sync</button>
    <ul id="list"><li>Konstantinov</li></ul>
  </div>

  <!-- Sciprts -->
  <script src="./ДЗ_2_final_files/pouchdb.min.js.Без названия"></script>
  <script>
    let data = []

    const DBS = {
      // Создаем локальную БД и коннектимся к удаленной 
      Local: new PouchDB('docs'),
      Remote: new PouchDB('http://admin:qq123@localhost:5984/student')
    }

    // Иницииируем реприкацию
    const sync = DBS.Local.sync(DBS.Remote, {
      live: true,
      retry: true
    }).on('change', ({ change }) => {
      // обрабатываем изменения если в процессе синхронизации локлаьной бд таковые произошли
      const doc = change.docs[0]
      // deleted это просто флаг
      if (doc._deleted) {
        data = data.filter(item => item._id != doc._id)
      } else {
        data = data.concat(doc)
      }
      // рисуем саму html табличку
      render(data)
    })

    const render = data => {
      list.innerHTML = data.map(item => `<li>${item.name}</li>`).join('')
    }

    // получение всех документов  
    const fetch = () => {
      DBS.Local.allDocs({ include_docs: true })
        .then(result => {
          data = result.rows.map(r => r.doc)
          render(data)
        })
    }

    // Events
    const addBtn = document.querySelector('#add')
    const removeBtn = document.querySelector('#remove')
    const list = document.querySelector('#list')
    const syncBtn = document.querySelector('#sync')

    addBtn.addEventListener('click', () => {
      const item = { name: new Date() }
      DBS.Local.post(item)
    })

    removeBtn.addEventListener('click', () => {
      const item = data.pop()
      if (!item) return
      DBS.Local.remove(item)
    })

    syncBtn.addEventListener('click', () => fetch())

  </script>


</body></html>